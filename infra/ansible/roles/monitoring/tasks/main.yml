---
# Monitoring Setup
# Installs and configures monitoring tools (node exporter, etc.)

- name: Install monitoring prerequisites
  apt:
    name:
      - curl
      - wget
    state: present

- name: Create monitoring directories
  file:
    path: "{{ item }}"
    state: directory
    mode: '0755'
  loop:
    - /opt/monitoring
    - /opt/monitoring/exporters

# Node Exporter (for host metrics)
- name: Download Node Exporter
  unarchive:
    src: "https://github.com/prometheus/node_exporter/releases/download/v1.7.0/node_exporter-1.7.0.linux-amd64.tar.gz"
    dest: /opt/monitoring/exporters
    remote_src: yes
    mode: '0755'

- name: Create node_exporter symlink
  file:
    src: /opt/monitoring/exporters/node_exporter-1.7.0.linux-amd64/node_exporter
    dest: /usr/local/bin/node_exporter
    state: link

- name: Create node_exporter systemd service
  copy:
    content: |
      [Unit]
      Description=Node Exporter
      After=network.target

      [Service]
      Type=simple
      User=nobody
      Group=nogroup
      ExecStart=/usr/local/bin/node_exporter \
        --collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)
      Restart=always

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/node_exporter.service
    mode: '0644'
  notify: Restart node_exporter

- name: Enable and start node_exporter
  systemd:
    name: node_exporter
    state: started
    enabled: yes
    daemon_reload: yes

# Google Cloud Ops Agent (for Cloud Monitoring)
- name: Check if Ops Agent is installed
  command: dpkg -l google-cloud-ops-agent
  register: ops_agent_check
  changed_when: false
  failed_when: false

- name: Add Google Cloud Ops Agent repository
  shell: |
    curl -sSO https://dl.google.com/cloudagents/add-google-cloud-ops-agent-repo.sh
    bash add-google-cloud-ops-agent-repo.sh
    rm add-google-cloud-ops-agent-repo.sh
  args:
    creates: /etc/apt/sources.list.d/google-cloud-ops-agent.list
  when: ops_agent_check.rc != 0

- name: Install Google Cloud Ops Agent
  apt:
    name: google-cloud-ops-agent
    state: present
    update_cache: yes
  when: ops_agent_check.rc != 0

- name: Configure Ops Agent for Exit8
  copy:
    content: |
      # Exit8 Ops Agent Configuration
      logging:
        receivers:
          exit8_app:
            type: files
            include_paths:
              - {{ app_dir }}/logs/*.log
            record_log_file_path: true
        service:
          pipelines:
            default_pipeline:
              receivers: [exit8_app]
      metrics:
        receivers:
          hostmetrics:
            type: hostmetrics
            collection_interval: 60s
        service:
          pipelines:
            default_pipeline:
              receivers: [hostmetrics]
    dest: /etc/google-cloud-ops-agent/config.yaml
    mode: '0644'
  notify: Restart ops-agent

- name: Ensure Ops Agent is running
  systemd:
    name: google-cloud-ops-agent
    state: started
    enabled: yes

- name: Display monitoring status
  debug:
    msg: |
      Monitoring installed:
      - Node Exporter: http://localhost:9100/metrics
      - Ops Agent: Cloud Monitoring integration
