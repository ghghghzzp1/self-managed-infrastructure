# service-a Backend API 직접 프록시 설정
# 외부 부하테스트(JMeter 등)에서 service-a-backend에 직접 접근하기 위한 설정
#
# 부하테스트 대상 엔드포인트:
#   POST /api/load/cpu?durationMs=N
#   POST /api/load/db-read?repeatCount=N
#   POST /api/load/db-write?repeatCount=N
#   POST /api/load/redis/warmup
#   GET  /api/circuit/test
#   GET  /api/system/health
#   GET  /api/system/snapshot
#   POST /api/system/rate-limit/toggle
#   POST /api/system/redis-cache/toggle
#   GET  /api/system/recent-requests?limit=N

server {
    listen 8081;
    server_name _;

    # 부하테스트용 timeout 설정
    # CPU 부하 시나리오는 수 초간 블로킹될 수 있으므로 넉넉하게 설정
    proxy_connect_timeout   10s;
    proxy_read_timeout      120s;
    proxy_send_timeout      30s;

    # 부하테스트 중 응답 버퍼링 비활성화 (메모리 절약)
    proxy_buffering         off;

    location /api/ {
        proxy_pass         http://service-a-backend:8080;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";           # HTTP keepalive 활성화
        proxy_set_header   Host               $host;
        proxy_set_header   X-Real-IP          $remote_addr;
        proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header   X-Forwarded-Proto  $scheme;
    }

    location /actuator/ {
        proxy_pass         http://service-a-backend:8080;
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        proxy_set_header   Host               $host;
        proxy_set_header   X-Real-IP          $remote_addr;
        proxy_set_header   X-Forwarded-For    $proxy_add_x_forwarded_for;
    }
}
