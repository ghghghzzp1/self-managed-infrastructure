# NPM custom http block 설정
# 이 파일만 NPM이 http block 내에 include함 (/data/nginx/custom/http.conf)
#
# service-a-api.conf, service-b-api.conf 등 다른 이름의 파일은 NPM이 무시함

# ============================================================
# GCP Load Balancer 헬스 체크 + service-a Backend API 프록시 (port 8081)
# Terraform: load_balancer.tf health check port=8081, path=/health
# port 8081은 실제 NPM이 서비스 중인 포트 → Connection refused 없음
# 방화벽: compute.tf allow_health_check 에 8081 추가됨
# ============================================================
server {
    listen 8081;
    server_name _;

    proxy_connect_timeout   10s;
    proxy_read_timeout      120s;   # CPU load 시나리오 수 초 블로킹 대응
    proxy_send_timeout      30s;
    proxy_buffering         off;

    # GCP LB 헬스 체크 응답
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # service-a Backend API 직접 프록시 (부하테스트용)
    # 대상 엔드포인트:
    #   POST /api/load/cpu?durationMs=N
    #   POST /api/load/db-read?repeatCount=N
    #   POST /api/load/db-write?repeatCount=N
    #   POST /api/load/redis/warmup
    #   GET  /api/circuit/test
    #   GET  /api/system/health
    #   GET  /api/system/snapshot
    #   POST /api/system/rate-limit/toggle
    #   POST /api/system/redis-cache/toggle
    #   GET  /api/system/recent-requests?limit=N
    location /api/ {
        proxy_pass          http://service-a-backend:8080;
        proxy_http_version  1.1;
        proxy_set_header    Connection          "";
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto   $scheme;
    }

    location /actuator/ {
        proxy_pass          http://service-a-backend:8080;
        proxy_http_version  1.1;
        proxy_set_header    Connection          "";
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    }
}
