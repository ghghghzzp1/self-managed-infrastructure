# NPM custom http block 설정
# 이 파일만 NPM이 http block 내에 include함 (/data/nginx/custom/http.conf)
#
# service-a-api.conf, service-b-api.conf 등 다른 이름의 파일은 NPM이 무시함

# ============================================================
# service-a Backend API 직접 프록시 (부하테스트용)
# 대상 엔드포인트:
#   POST /api/load/cpu?durationMs=N
#   POST /api/load/db-read?repeatCount=N
#   POST /api/load/db-write?repeatCount=N
#   POST /api/load/redis/warmup
#   GET  /api/circuit/test
#   GET  /api/system/health
#   GET  /api/system/snapshot
#   POST /api/system/rate-limit/toggle
#   POST /api/system/redis-cache/toggle
#   GET  /api/system/recent-requests?limit=N
# ============================================================
# ============================================================
# GCP Load Balancer 헬스 체크 전용 (port 8080)
# Terraform: load_balancer.tf health check port=8080, path=/health
# NPM이 port 80을 직접 관리하므로 충돌 없는 8080 포트 사용
# ============================================================
server {
    listen 8080;
    server_name _;

    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    location / {
        return 404;
    }
}

# ============================================================
# service-a Backend API 직접 프록시 (부하테스트용, port 8081)
# ============================================================
server {
    listen 8081;
    server_name _;

    proxy_connect_timeout   10s;
    proxy_read_timeout      120s;   # CPU load 시나리오 수 초 블로킹 대응
    proxy_send_timeout      30s;
    proxy_buffering         off;

    location /api/ {
        proxy_pass          http://service-a-backend:8080;
        proxy_http_version  1.1;
        proxy_set_header    Connection          "";
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
        proxy_set_header    X-Forwarded-Proto   $scheme;
    }

    location /actuator/ {
        proxy_pass          http://service-a-backend:8080;
        proxy_http_version  1.1;
        proxy_set_header    Connection          "";
        proxy_set_header    Host                $host;
        proxy_set_header    X-Real-IP           $remote_addr;
        proxy_set_header    X-Forwarded-For     $proxy_add_x_forwarded_for;
    }
}
