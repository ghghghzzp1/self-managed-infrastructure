<group name="local_rules,">

  <!-- ===== Nginx based detection (URL/query pattern matching) ===== -->
  <rule id="100100" level="12">
    <if_sid>31103, 31106, 31110, 31151</if_sid>
    <match type="pcre2">(?i)(union[\s\+]+select|'\s*(or|and)\b|--|/\*|\*/|sleep\(|benchmark\(|information_schema|%27\s*(or|and)\b)</match>
    <description>Critical: SQL Injection Attempt Detected!</description>
    <group>sql_injection_alert</group>
  </rule>

  <rule id="100101" level="12" frequency="8" timeframe="120">
    <if_matched_sid>5710</if_matched_sid>
    <same_source_ip />
    <description>Critical: SSH Brute Force Attack Detected!</description>
    <group>bruteforce_alert</group>
  </rule>

  <!-- ===== Service-B Backend JSON log based detection ===== -->

  <!-- Parent rule: identify service-b backend JSON log -->
  <rule id="100200" level="0">
    <decoded_as>json</decoded_as>
    <location>/var/ossec/logs/service-b-backend/app.log</location>
    <description>Service-B Backend application log</description>
  </rule>

  <!-- SQL Injection: trigger immediately on backend SUSPICIOUS_INPUT -->
  <rule id="100201" level="12">
    <if_sid>100200</if_sid>
    <field name="message">SUSPICIOUS_INPUT</field>
    <description>Critical: SQL Injection Attempt Detected in Service-B Login (POST body)!</description>
    <group>sql_injection_alert</group>
  </rule>

  <!-- Login failure event (for brute-force counting) -->
  <rule id="100202" level="5">
    <if_sid>100200</if_sid>
    <field name="message">AUTH_UNAUTHORIZED</field>
    <description>Service-B Login Authentication Failed</description>
    <group>authentication_failed</group>
  </rule>

  <!-- Brute Force: 5+ failed auths from same IP in 60 seconds -->
  <rule id="100203" level="12" frequency="5" timeframe="60">
    <if_matched_sid>100202</if_matched_sid>
    <same_field>ip</same_field>
    <description>Critical: Brute Force Attack Detected on Service-B Login!</description>
    <group>bruteforce_alert</group>
  </rule>

</group>

