spring:
  application:
    name: service-a-backend
  lifecycle:
    timeout-per-shutdown-phase: 20s
  jpa:
    database-platform: org.hibernate.dialect.PostgreSQLDialect
    hibernate:
      ddl-auto: update # create update
    show-sql: false
    properties:
      hibernate:
        format_sql: true

  datasource:
    hikari:
      maximum-pool-size: 50  # 동시에 가질 수 있는 커넥션 수 증가
      minimum-idle: 10 # 커넥션 풀의 “항상 유지되는 최소 유휴(Idle) 커넥션 수
      connection-timeout: 3000 # 커넥션 획득 대기 시간 (3초)
      validation-timeout: 1000 # 커넥션 검증 시 최대 1초까지 대기
      leak-detection-threshold: 10000 # 10초 이상 커넥션을 점유하면 경고 (현재 발생 중인 에러 방지)

  data:
    redis:
      timeout: 1000ms
      lettuce:
        pool:
          max-active: 55   # Redis 동시 연결 최대 수
          max-idle: 10     # 유휴 연결 최대 유지 수
          min-idle: 2      # 최소 유휴 연결 유지 수

  # GCP Secret Manager (replaces Vault)
  # Secrets are now loaded from environment variables
  # DATABASE_HOST, DATABASE_PORT, DATABASE_NAME, DATABASE_USER, DATABASE_PASSWORD
  # REDIS_HOST, REDIS_PORT

  port: 8080
  shutdown: graceful

management:
  health:
    circuitbreakers:
      enabled: true # 서킷 브레이커 상태를 /actuator/health에 포함
    redis:
      enabled: true
  endpoints:
    web:
      exposure:
        include: "health,prometheus,metrics,circuitbreakers"
  metrics:
    tags:
      application: ${spring.application.name}

resilience4j.circuitbreaker:
  configs:
    default: # 공통 설정
      # 최근 호출 기준 설정
      sliding-window-type: COUNT_BASED
      sliding-window-size: 20
      minimum-number-of-calls: 20
      failure-rate-threshold: 50
  instances:
    testCircuit:
      baseConfig: default
      automatic-transition-from-open-to-half-open-enabled: true # 자동 전환 옵션
      register-health-indicator: true
      slow-call-duration-threshold: 2000
      slow-call-rate-threshold: 50
      wait-duration-in-open-state: 10s
      # HALF_OPEN 상태에서 허용 호출 수
      permitted-number-of-calls-in-half-open-state: 3
      # 예외 기록 기준
      record-exceptions:
        - java.lang.Exception
      # 성공으로 간주할 예외 (없음)
      ignore-exceptions: []

# Rate Limit 적용
rate-limit:
  enabled: ${RATE_LIMIT_ENABLED:false} # 환경변수로 조절 가능하게 설정

# Redis 적용
redis-cache:
  enabled: ${REDIS_CACHE_ENABLED:false}

# 2-Tier Cache Settings (Caffeine L1 + Redis L2)
cache:
  caffeine:
    max-size: ${CAFFEINE_MAX_SIZE:1000}
    expire-after-write: ${CAFFEINE_EXPIRE_AFTER_WRITE:300}
  redis:
    default-ttl: ${REDIS_CACHE_TTL:600}
