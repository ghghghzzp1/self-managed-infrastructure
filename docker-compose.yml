# ==========================================
# 16GB / 4core 서버 최적화 설정
# 총 메모리 limit:   ~12.6GB
# 총 메모리 예약:    ~6.4GB
# 시스템 예약:       ~3.4GB
#
# 레이어별 limit 분배:
#   Wazuh SIEM:      ~6.1GB (manager 2G + indexer 3G + dashboard 1G)
#   데이터:          ~2.0GB (postgres 1.5G + redis 512M)
#   애플리케이션:    ~2.2GB (svc-a 1G + svc-b 768M + frontends 384M)
#   인프라/관측:     ~2.3GB (vault 384M + prometheus 768M + grafana 512M + npm 512M)
#   Exporters:       ~384M
# ==========================================

# 공통 로그 설정 (YAML anchor)
x-logging: &default-logging
  driver: json-file
  options:
    max-size: "10m"
    max-file: "3"

services:
  # ===================
  # 퍼블릭 레이어
  # ===================
  nginx-proxy-manager:
    image: jc21/nginx-proxy-manager:2.11.3
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "81:81"    # Admin UI
      - "8081:8081"  # service-a API (부하테스트 직접 접근용)
    volumes:
      - npm_data:/data
      - npm_letsencrypt:/etc/letsencrypt
      - ./services/npm/custom/http.conf:/data/nginx/custom/http.conf
    networks:
      - frontend
      - backend
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
  # ==========
  # 데이터 레이어 (GCP Managed Services)
  # Cloud SQL: 10.101.0.3:5432
  # Memorystore: 10.101.1.3:6379
  # ==========

  # =================
  # 애플리케이션 레이어
  # =================

  # Service A - Backend (Spring Boot)
  service-a-backend:
    image: exit8/service-a-backend:latest
    container_name: service-a-backend
    restart: unless-stopped
    ports:
      - "8082:8080"
    environment:
      SPRING_PROFILES_ACTIVE: gcp
      JAVA_OPTS: "-Xms512m -Xmx768m -XX:+UseG1GC -XX:MaxGCPauseMillis=100"
      # GCP Cloud SQL
      DATABASE_HOST: ${DATABASE_HOST:-10.101.0.3}
      DATABASE_PORT: ${DATABASE_PORT:-5432}
      DATABASE_NAME: ${DATABASE_NAME:-exit8_app}
      DATABASE_USER: ${DATABASE_USER:-exit8_app_user}
      DATABASE_PASSWORD: ${DATABASE_PASSWORD}
      # Override datasource URL: sslmode=require only (ssl=true legacy param caused 08001 handshake error)
      SPRING_DATASOURCE_URL: "jdbc:postgresql://${DATABASE_HOST:-10.101.0.3}:${DATABASE_PORT:-5432}/${DATABASE_NAME:-exit8_app}?sslmode=require"
      # GCP Memorystore Redis
      REDIS_HOST: ${REDIS_HOST:-10.101.1.3}
      REDIS_PORT: ${REDIS_PORT:-6379}
      # Initial DB schema creation (change to validate after first run)
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
    networks:
      - backend
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging: *default-logging

  # Service A - Frontend (Nginx)
  service-a-frontend:
    image: exit8/service-a-frontend:latest
    container_name: service-a-frontend
    restart: unless-stopped
    ports:
      - "3000:8080"
    volumes:
      - service-a-logs:/var/log/nginx
    networks:
      - frontend
      - backend
    depends_on:
      service-a-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *default-logging
    deploy:
  # Service B - Backend (FastAPI)
  service-b-backend:
    image: exit8/service-b-backend:latest
    container_name: service-b-backend
    restart: unless-stopped
    expose:
      - "8000"
    environment:
      # GCP Cloud SQL
      POSTGRES_SERVER: ${DATABASE_HOST:-10.101.0.3}
      POSTGRES_PORT: ${DATABASE_PORT:-5432}
      POSTGRES_DB: ${DATABASE_NAME:-exit8_app}
      POSTGRES_USER: ${DATABASE_USER:-exit8_app_user}
      POSTGRES_PASSWORD: ${DATABASE_PASSWORD}
      # GCP Memorystore Redis
      REDIS_HOST: ${REDIS_HOST:-10.101.1.3}
      REDIS_PORT: ${REDIS_PORT:-6379}
    networks:
      - backend
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging: *default-logging

  # Service B - Frontend (Nginx)
  service-b-frontend:
    image: exit8/service-b-frontend:latest
    container_name: service-b-frontend
    restart: unless-stopped
    ports:
      - "3002:8080"
    volumes:
      - service-b-logs:/var/log/nginx
    networks:
      - frontend
      - backend
    depends_on:
      service-b-backend:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://127.0.0.1:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *default-logging
    deploy:
  # ==============
  # ==============
  # 보안 모니터링 레이어 (Wazuh SIEM)
  # ==============
  # 보안 모니터링 레이어 (Wazuh SIEM)
  # ==============
  wazuh.manager:
    image: wazuh/wazuh-manager:4.9.2
    hostname: wazuh.manager
    restart: always
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 655360
        hard: 655360
    ports:
      - "1514:1514"
      - "1515:1515"
      - "514:514/udp"
      - "55000:55000"
    environment:
      - INDEXER_URL=https://wazuh.indexer:9200
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - FILEBEAT_SSL_VERIFICATION_MODE=full
      - SSL_CERTIFICATE_AUTHORITIES=/etc/ssl/root-ca.pem
      - SSL_CERTIFICATE=/etc/ssl/filebeat.pem
      - SSL_KEY=/etc/ssl/filebeat.key
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=${WAZUH_API_PASSWORD}
    volumes:
      - wazuh_api_configuration:/var/ossec/api/configuration
      - wazuh_etc:/var/ossec/etc
      - wazuh_logs:/var/ossec/logs
      - wazuh_queue:/var/ossec/queue
      - wazuh_tmp:/var/ossec/tmp
      - wazuh_var_multigroups:/var/ossec/var/multigroups
      - wazuh_integrations:/var/ossec/integrations
      - wazuh_active_response:/var/ossec/active-response/bin
      - wazuh_agentless:/var/ossec/agentless
      - wazuh_wodles:/var/ossec/wodles
      - filebeat_etc:/etc/filebeat
      - filebeat_var:/var/lib/filebeat
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/root-ca-manager.pem:/etc/ssl/root-ca.pem
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.manager.pem:/etc/ssl/filebeat.pem
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.manager-key.pem:/etc/ssl/filebeat.key
     # - ./services/wazuh/config/wazuh_cluster/wazuh_manager.conf:/var/ossec/etc/ossec.conf:ro
      - service-a-logs:/var/ossec/logs/nginx/service-a:ro
      - service-b-logs:/var/ossec/logs/nginx/service-b:ro
    networks:
      - wazuh_internal
      - backend
    logging: *default-logging
    deploy:
  wazuh.indexer:
    image: wazuh/wazuh-indexer:4.9.2
    hostname: wazuh.indexer
    restart: always
    ports:
      - "9200:9200"
    environment:
      # JVM 힙 1GB + direct memory 512MB → 컨테이너 limit 3072MB
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g -XX:MaxDirectMemorySize=512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    volumes:
      - wazuh-indexer-data:/var/lib/wazuh-indexer
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-indexer/certs/root-ca.pem
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.indexer-key.pem:/usr/share/wazuh-indexer/certs/wazuh.indexer.key
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.indexer.pem:/usr/share/wazuh-indexer/certs/wazuh.indexer.pem
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/admin.pem:/usr/share/wazuh-indexer/certs/admin.pem
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/admin-key.pem:/usr/share/wazuh-indexer/certs/admin-key.pem
      - ./services/wazuh/config/wazuh_indexer/wazuh.indexer.yml:/usr/share/wazuh-indexer/opensearch.yml
      - ./services/wazuh/config/wazuh_indexer/internal_users.yml:/usr/share/wazuh-indexer/opensearch-security/internal_users.yml
    networks:
      - wazuh_internal
    logging: *default-logging
    deploy:
  wazuh.dashboard:
    image: wazuh/wazuh-dashboard:4.9.2
    hostname: wazuh.dashboard
    restart: always
    ports:
      - "8443:5601"
    environment:
      - INDEXER_USERNAME=admin
      - INDEXER_PASSWORD=${WAZUH_INDEXER_PASSWORD}
      - WAZUH_API_URL=https://wazuh.manager
      - DASHBOARD_USERNAME=kibanaserver
      - DASHBOARD_PASSWORD=${WAZUH_DASHBOARD_PASSWORD}
      - API_USERNAME=wazuh-wui
      - API_PASSWORD=${WAZUH_API_PASSWORD}
    volumes:
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.dashboard.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem:/usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
      - ./services/wazuh/config/wazuh_indexer_ssl_certs/root-ca.pem:/usr/share/wazuh-dashboard/certs/root-ca.pem
      - ./services/wazuh/config/wazuh_dashboard/opensearch_dashboards.yml:/usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
      - ./services/wazuh/config/wazuh_dashboard/wazuh.yml:/usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml
      - wazuh-dashboard-config:/usr/share/wazuh-dashboard/data/wazuh/config
      - wazuh-dashboard-custom:/usr/share/wazuh-dashboard/plugins/wazuh/public/assets/custom
    depends_on:
      - wazuh.indexer
    links:
      - wazuh.indexer:wazuh.indexer
      - wazuh.manager:wazuh.manager
    networks:
      - wazuh_internal
      - frontend
      - backend
    logging: *default-logging
    deploy:
  # ===================
  # 관측 레이어
  # ===================
  prometheus:
    image: prom/prometheus:v2.48.0
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./services/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--storage.tsdb.retention.size=2GB'
      - '--web.enable-lifecycle'
    networks:
      - backend
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 768M
        reservations:
          memory: 384M

  grafana:
    image: grafana/grafana:10.2.2
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_USER}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_PASSWORD}
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./services/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./services/grafana/dashboards:/var/lib/grafana/dashboards:ro
    depends_on:
      - prometheus
    networks:
      - backend
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  # Exporters for metrics collection
  node-exporter:
    image: prom/node-exporter:v1.7.0
    container_name: node-exporter
    restart: unless-stopped
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--path.rootfs=/rootfs'
      - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
    networks:
      - backend
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: postgres-exporter
    restart: unless-stopped
    environment:
      DATA_SOURCE_NAME: "postgresql://${DATABASE_USER:-exit8_app_user}:${DATABASE_PASSWORD}@${DATABASE_HOST:-10.101.0.3}:${DATABASE_PORT:-5432}/${DATABASE_NAME:-exit8_app}?sslmode=require"
    networks:
      - backend
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
  redis-exporter:
    image: oliver006/redis_exporter:v1.55.0
    container_name: redis-exporter
    restart: unless-stopped
    environment:
      REDIS_ADDR: ${REDIS_HOST:-10.101.1.3}:${REDIS_PORT:-6379}
    networks:
      - backend
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
networks:
  frontend:
    driver: bridge
  backend:
    driver: bridge
  db:
    driver: bridge
  wazuh_internal:
    driver: bridge

volumes:
  npm_data:
  npm_letsencrypt:
  prometheus_data:
  service-a-logs:
  service-b-logs:
  wazuh_api_configuration:
  wazuh_etc:
  wazuh_logs:
  wazuh_queue:
  wazuh_tmp:
  wazuh_var_multigroups:
  wazuh_integrations:
  wazuh_active_response:
  wazuh_agentless:
  wazuh_wodles:
  filebeat_etc:
  filebeat_var:
  wazuh-indexer-data:
  wazuh-dashboard-config:
  wazuh-dashboard-custom:
  grafana_data:
